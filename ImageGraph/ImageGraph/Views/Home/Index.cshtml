@{
   ViewData["Title"] = "Home Page";
}

<head>
   <meta charset="utf-8">
   <title>Satellite Navigator</title>
   <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
   <!-- UIkit CSS -->
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.6.21/dist/css/uikit.min.css" />

   <!-- UIkit JS -->
   <script src="https://cdn.jsdelivr.net/npm/uikit@3.6.21/dist/js/uikit.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/uikit@3.6.21/dist/js/uikit-icons.min.js"></script>
   <script>
      function FindPosition(oElement) {
         if (typeof (oElement.offsetParent) != "undefined") {
            for (var posX = 0, posY = 0; oElement; oElement = oElement.offsetParent) {
               posX += oElement.offsetLeft;
               posY += oElement.offsetTop;
            }
            return [posX, posY];
         }
         else {
            return [oElement.x, oElement.y];
         }
      }

      function GetCoordinates(e) {
         var PosX = 0;
         var PosY = 0;
         var ImgPos;
         ImgPos = FindPosition(myImg);
         if (!e) var e = window.event;
         if (e.pageX || e.pageY) {
            PosX = e.pageX;
            PosY = e.pageY;
         }
         else if (e.clientX || e.clientY) {
            PosX = e.clientX + document.body.scrollLeft
               + document.documentElement.scrollLeft;
            PosY = e.clientY + document.body.scrollTop
               + document.documentElement.scrollTop;
         }
         PosX = PosX - ImgPos[0];
         PosY = PosY - ImgPos[1];

         document.getElementById("x").innerHTML = PosX;
         document.getElementById("y").innerHTML = PosY;
         document.getElementById("points").innerHTML = parseInt(document.getElementById("points").innerHTML,10) + 1;
         var cors = JSON.parse(localStorage.getItem("cors"));
         var point = {
            X : PosX,
            Y : PosY
         };

         if(cors == null) cors = []
         cors.push(point);
         localStorage.setItem("cors", JSON.stringify(cors));
      }

      function previewFile(input) {
         localStorage.clear();
         var file = $("input[type=file]").get(0).files[0];

         if (file) {
            var reader = new FileReader();

            reader.onload = function () {
               $("#myImgId").attr("src", reader.result);
            }

            reader.readAsDataURL(file);
         }
      }

      function sendFile() {
         var photo = document.getElementById("file").files[0];
         var formData = new FormData();
     
         formData.append("file", photo);
         fetch('/file', { method: "POST", body: formData })
            .then(data => console.log(data))
            .then(getPath());
      }

      function clearPoints() {
         localStorage.clear();
         document.getElementById("points").innerHTML = 0;
      }

      $(document).ready(function () {
         $("#myImgId").click(function (e) {
            if (!point2) {
               $('img[src*="/2703060-64.png"]').remove();
            }
            point2 = !point2
            e.preventDefault();
            var PosX = 0;
            var PosY = 0;
            var ImgPos;
            ImgPos = FindPosition(myImg);
            if (!e) var e = window.event;
            if (e.pageX || e.pageY) {
               PosX = e.pageX;
               PosY = e.pageY;
            }
            else if (e.clientX || e.clientY) {
               PosX = e.clientX + document.body.scrollLeft
                  + document.documentElement.scrollLeft;
               PosY = e.clientY + document.body.scrollTop
                  + document.documentElement.scrollTop;
            }
            var x = PosX - ImgPos[0];
            var y = PosY - ImgPos[1];
            var img = $('<img>');
            img.css('top', y - 20);
            img.css('left', x - 10);
            img.attr('width', 20);
            img.attr('height', 20);
            img.addClass("image2");
            img.attr('src', '/2703060-64.png');
            img.appendTo('#maping');
         })
      });

      $(document).ready(function () {
         $("#file").click(function (e) {
            console.log('removing');
            $('img[src*="/2703060-64.png"]').remove();
         })
      });

      var point2 = false;

      function getPath() {
         var cors = JSON.parse(localStorage.getItem("cors"));
         var scale = document.getElementById("scale").value;

         var myImg = document.getElementById("myImgId");
         var fullPath = document.getElementById('file').value;
         var filename = "";
         if (fullPath) {
            var startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
            filename = fullPath.substring(startIndex);
            if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
               filename = filename.substring(1);
            }
         }

         var realWidth = myImg.clientWidth;
         var realHeight = myImg.clientHeight;
         var dat = JSON.stringify({
            "cors": cors,
            "MaxX": realWidth,
            "MaxY": realHeight,
            "FileName": filename,
            "Scale": scale
         });

         $.ajax({
            type: 'POST',
            url: "path",
            data: dat,
            contentType: "application/json",
            success: function (result) {
               console.log(result);
               if(result){
                  $("#outPutId").attr("src", result.img);
                  document.getElementById("pathLen").innerHTML = "Довжина шляху:  " + result.len  + " м";
               }
            },
            error: function (data) {
               console.log(data);
            }
         });
      }
   </script>
</head>

<div class="uk-flex">
   <div class="uk-card uk-card-default uk-card-body">
      <div id="maping" class="parent">
         <img id="myImgId" class="image1" alt="" width="500" />
      </div>
   </div>
   <div class="uk-card uk-card-default uk-card-body uk-margin-left">
      <div style="display: flex;">
         <div style="width: 50%;">
            <p>X:<span id="x"></span></p>
            <p>Y:<span id="y"></span></p>
            <p>Точок: <span id="points">0</span></p>
         </div>
      </div>

      <div style="display: flex; flex-direction: column;">
         <p>
            <input type="file" id="file" name="file" onchange="previewFile(this);">
            <button class="btn btn-success" onclick="sendFile();">Надіслати</button>
         </p>
         <button style="width: 50%;" class="btn btn-success" onclick="clearPoints();">Очистити точки</button>
         <label for="scale">Масштаб</label>
         <input id="scale" type="text" style="width: 50%;" placeholder="3.6329">
         <span id="pathLen"></span>
      </div>
   </div>
   <div class="uk-card uk-card-default uk-card-body uk-margin-left">
      <div id="mapingOutput">
         <img id="outPutId" width="500" />
      </div>
   </div>
</div>

<script type="text/javascript">
   <!--
   var myImg = document.getElementById("myImgId");
   myImg.onmousedown = GetCoordinates;
//-->
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>


<style>
   .parent {
      position: relative;
      top: 0;
      left: 0;
   }

   .image1 {
      position: relative;
      border: 1px red solid;
   }

   .image2 {
      position: absolute;
   }
</style>